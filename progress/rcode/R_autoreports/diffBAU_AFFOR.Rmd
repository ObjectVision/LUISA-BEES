---
title: "Assessment of effective afforestation differences between BAU and Afforestation scenarios"
author: "Sarah"
date: "March 2022"
output:
  word_document: 
    toc: yes
  html_document: 
      toc: yes
  pdf_document: 
    number_sections: yes
    toc: yes
---

```{r setup, include=TRUE, message=FALSE, warning=FALSE,echo=FALSE}

knitr::opts_chunk$set(fig.width = 7,
                      fig.height = 4)
#setwd("C:/LUISA-BEES/LUISA-BEES/progress/rcode/R_autoreports")
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "..") # file path relative to the root of the project directory
#install.packages("E:\\mubarsa\\Documents\\Downloads\\rlang_0.3.1.gz", repos = NULL, type = "source")
#install.packages("ggplot2", dep = TRUE)
#install.packages("dplyr", dep = TRUE)
#install.packages("tidyverse", dep = TRUE)
library(ggplot2)
library(rlang)
library(purrr)
library(dplyr)
library(hms)
library(tidyverse)
library(readxl)
#library(ggplot2)
library(zoo)
library(data.table)
library(foreign)
library(networkD3)
library(rmarkdown)
```
# Introduction

The output of the land use model LUISA-BEES is reported here..
# Reads output files
```{r,echo=FALSE}
datadirAFF<-"C:/LUISA-BEES_2022/LUISA-BEES/results/StatusQuoAFF"
datadirBAU<-"C:/LUISA-BEES_2022/LUISA-BEES/results/StatusQuoREF"
countrydir<-"D:/landuse/LUISA-BEES_outmay162020"
countries<-list.dirs(countrydir, full.names = FALSE, recursive=FALSE)
year<-c("2020","2025","2030","2035","2040","2045","2050")

```

#loop through files to get data and make graph
REFERENCE scenario
```{r,echo=FALSE}

filename<-"_xTabData.csv"
baulist<-list.files(datadirBAU)
wholelist<-list()
for (y in seq_along(year)) {
  countrylist = list()
  for (i in seq_along(countries)) {
    xtab<-read.csv(paste0(datadirBAU,"/AI00_AW20_", countries[i],"_P",year[y], filename), sep = ";")
    xtab$year<-year[y]
    xtab$country<-countries[i]
    countrylist[[i]] <- xtab
  }
  allcountries = do.call(rbind, countrylist)
  wholelist[[y]] <- allcountries
}
 xTabBau_all = do.call(rbind,wholelist)

```
AFFORESTATION scenario
```{r,echo=FALSE}

filename<-"_xTabData.csv"
afflist<-list.files(datadirAFF)
wholelist<-list()
for (y in seq_along(year)) {
  countrylist = list()
  for (i in seq_along(countries)) {
    xtab<-read.csv(paste0(datadirAFF,"/AI00_AW20_", countries[i],"_P",year[y], filename), sep = ";")
    xtab$year<-year[y]
    xtab$country<-countries[i]
    countrylist[[i]] <- xtab
  }
  allcountries = do.call(rbind, countrylist)
  wholelist[[y]] <- allcountries
}
 xTabAff_all = do.call(rbind,wholelist)

```
EU forest land conversions for the simulation period 2020-2050

```{r}
xTabAff_for<-grep("Forest land", xTabAff_all$Label)
aff_sumEUfor<-aggregate(xTabAff_all$count[xTabAff_for], by=list(year=xTabAff_all$year[xTabAff_for], country=xTabAff_all$country[xTabAff_for]), FUN=sum)
#EU average
euflAFF<-aff_sumEUfor %>%
  group_by(year) %>%
  summarize(sumForest = sum(x))

xTabBau_for<-grep("Forest land", xTabBau_all$Label)
bau_sumEUfor<-aggregate(xTabBau_all$count[xTabBau_for], by=list(year=xTabBau_all$year[xTabBau_for], country=xTabBau_all$country[xTabBau_for]), FUN=sum)
#bau_plot<-aggregate(eu_plot1$x, by=list(year_allEU=eu_plot1$year), FUN=sum)
#EU average
euflBAU<-bau_sumEUfor %>%
  group_by(year) %>%
  summarize(sumForest = sum(x))  
  
```
Plot for EU
```{r}

plotperEU<-ggplot(euflAFF,aes(x=year, y=sumForest)) + geom_point() +labs (title = "Forest land 2020-2050",y="ha forest land", x="year") + geom_point(data = euflBAU, color = "red")


```
Plot per country
```{r}

plotpercountry<-ggplot(aff_sumEUfor,aes(x=year, y=x,group=country,color=country)) + geom_line() +labs (title = "Forest land 2020-2050",y="ha forest land", x="year")

```
#loop through folders to get xTab2050 data and make Sankeys
The xTab files can either show overall conversion from the base year to the last year of the simulation, or yearly time step changes, depending on how the model output is configured.
```{r,echo=FALSE}
filename<-"P2050_xTabMT.dbf"
for (i in seq_along(list)) {
  xTab<-read.dbf(paste0(list[i],"/",filename))
  # Graphs of land use change
  ##Create Sankey diagrams
  lu<-unique(as.character(colnames(xTab)))
  #create nodes
  nodes <- data.frame(node = c(0:19), name = c(lu, "agriculture", "builtup", "forests",  "otherNature","newEnergyCrops")) 
  #create links
  #CREATE new column with land use type in xTab file:
  df<-cbind(lu,xTab)
  #SUM the columns of land uses that can be aggregated:
  df$builtup<-df$URBAN+df$INDUSTRIAL+df$ABANURBAN+df$ABANINDUST 
  df$agriculture<-df$ARABLE+df$PERMANENTC+ df$PASTURES+ df$ABANARABLE+ df$ABANPERMAN+ df$ABANPASTUR
  df$forests<-df$FORESTSMAT+ df$TRANSWOODL+ df$FORESTSYOU
  df$otherNature<-df$SHVA
  df$newEnergyCrops<- df$NEWENERGYC

  df<-dplyr::select (df,-c(URBAN, INDUSTRIAL, ARABLE, PERMANENTC, PASTURES, FORESTSMAT, TRANSWOODL, ABANARABLE, ABANPERMAN, ABANPASTUR, ABANURBAN, ABANINDUST, FORESTSYOU,NEWENERGYC, SHVA))
  #MERGE urban+industry=builtup; arable+PC+abandoned etc =agri; forests Y+M+Woodland summed
  # format in prep for sankey diagram
  links <- tidyr::gather(df, toLU, ha, -lu)
  luc <- merge(links, nodes, by.x = "lu", by.y = "name") 
  luc <- merge(luc, nodes, by.x = "toLU", by.y = "name")
  forSankey <- luc[ , c("node.x", "node.y", "ha")]
  colnames(forSankey) <- c("source", "target", "value")
  #remove rows containing 0 or else the lines will be drawn in the Sankey:
  gtzero<- apply(forSankey, 1, function(row) all(row !=0 ))
  ##Subset as usual
  forSankey<-forSankey[gtzero,]
 
   #make Sankey
 networkD3::sankeyNetwork(Links = forSankey, Nodes = nodes, 
  Source = 'source', 
  Target = 'target', 
  Value = 'value', 
  NodeID = 'name',
  units = 'ha')
  # saveNetwork(name, paste0(datadir,countries[i],"sankey1.pdf"), selfcontained = TRUE)

   ## Create Chord Network diagram

  chordNetwork(Data = xTab, width = 900, height = 900, colourScale =c("#FF0000", "#FF00FF", "#FFDD89", "#FF1212", "#00FF89", "#00FF00","#00FF99", "#FFDD89", "#00FF00", "#FF0000", "#FF0000", "#FF00FF","#FFDD89", "#00FF00","#00FF00"), labels = c("urban", "industry", "arable", "permCrops", "pastures", "forestMature", "woodland","abanArab", "abanPC", "abanPast", "abanUrban", "abanIndustry", "necr", "shva", "forestYoung"))
 #  shiny::renderPlot({
  #   chord
   #})
}
```


```{r,echo=FALSE}
for (i in seq_along(list)) {
  xTab<-read.dbf(paste0(list[i],"/",filename))
  #FOR nature, agri and builtup sankey:
  #SUM the columns of land uses that can be aggregated:
  #create nodes
  nodes <- data.frame(node = c(0:17), name = c(lu, "agriculture", "builtup", "nature")) 
  df<-xTab
  df$builtup<-df$URBAN+df$INDUSTRIAL+df$ABANURBAN+df$ABANINDUST 
  df$agriculture<-df$ARABLE+df$PERMANENTC+ df$PASTURES+ df$ABANARABLE+ df$ABANPERMAN+ df$ABANPASTUR+df$NEWENERGYC
  df$nature<-df$FORESTSMAT+ df$TRANSWOODL+ df$FORESTSYOU+df$SHVA
  df<-dplyr::select (df,-c(URBAN, INDUSTRIAL, ARABLE, PERMANENTC, PASTURES, FORESTSMAT, TRANSWOODL, ABANARABLE, ABANPERMAN, ABANPASTUR, ABANURBAN, ABANINDUST, FORESTSYOU,NEWENERGYC, SHVA))
  #MERGE urban+industry=builtup; arable+PC+abandoned etc =agri; nature= Y+M+Woodland summed
  # format in prep for sankey diagram
  links <- tidyr::gather(df, toLU, ha, -lu)
  luc <- merge(links, nodes, by.x = "lu", by.y = "name") 
  luc <- merge(luc, nodes, by.x = "toLU", by.y = "name")
  forSankey <- luc[ , c("node.x", "node.y", "ha")]
  colnames(forSankey) <- c("source", "target", "value")
  #remove rows containing 0 or else the lines will be drawn in the Sankey:
  gtzero<- apply(forSankey, 1, function(row) all(row !=0 ))
  ##Subset as usual
  forSankey<-forSankey[gtzero,]


  #make Sankey
  networkD3::sankeyNetwork(Links = forSankey, Nodes = nodes, 
  Source = 'source', 
  Target = 'target', 
  Value = 'value', 
  NodeID = 'name',
  units = 'ha')
}
```

